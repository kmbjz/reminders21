package bot

import (
	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
	"log"
	"reminders21/config"
	"reminders21/llm"
	"reminders21/speech"
	"reminders21/storage"
)

// The LLM prompt template
const llmPrompt = `
Текущее время: %s

Анализируй следующий запрос пользователя. Пользователь может просить создать, изменить или удалить несколько напоминаний в одном запросе, либо показать список своих напоминаний.

Если запрос на создание обычного напоминания, то:
• Извлеки дату и время напоминания ("datetime" в формате "2006-01-02 15:04:05"). Если дата не указана, используй сегодняшнюю. Пользователь может использовать относительные обозначения (например, "сегодня", "завтра", "через 10 минут", "после 1 часа") – рассчитай время на основе текущего времени.
• Извлеки текст напоминания ("label").
• Укажи действие "create".
• Сгенерируй ответ на русском в неформальном, но вежливом стиле, например: "Окей, я запомнил, что [label] в [время]."

Если запрос на создание повторяющегося напоминания, то:
• Распознай тип повторения ("recurring_type"): "daily" (каждый день), "weekly" (каждую неделю), "monthly" (каждый месяц).
• Извлеки время ("time" в формате "15:04").
• Для weekly: укажи день недели ("day_of_week": 0-6, где 0=воскресенье, 1=понедельник и т.д.).
• Для monthly: укажи день месяца ("day_of_month": 1-31).
• Извлеки текст напоминания ("label").
• Укажи действие "create_recurring".
• Сгенерируй ответ, например: "Создал регулярное напоминание о [label] [периодичность]. При генерации соблюдай грамматику русского языка."

Если запрос на изменение напоминания, то:
• Извлеки reminder_id напоминания, которое нужно изменить (выбери самое подходящее из списка).
• Для обычных напоминаний ID - это число, для повторяющихся - строка вида "rec_NUMBER".
• Извлеки новые дату/время (необязательно) и/или новый текст ("label") (необязательно).
• Для повторяющихся напоминаний: можно изменить тип повторения, день недели, день месяца или время.
• Укажи действие "adjust".
• Сгенерируй ответ, например: "Окей, я поменял напоминание."

Если запрос на удаление напоминания, то:
• Извлеки reminder_id напоминания, которое нужно удалить (выбери самое подходящее из списка).
• Для обычных напоминаний ID - это число, для повторяющихся - строка вида "rec_NUMBER".
• Укажи действие "delete".
• Сгенерируй ответ, например: "Окей, напоминание удалено."

Если запрос на показ списка обычных напоминаний, то:
• Укажи действие "show_list".
• Если пользователь задал период (например, "скажи дела на сегодня"), включи в ответ поля "start_date" и "end_date" (в формате "2006-01-02"). Если указана только start_date, значит запрос на конкретный день.
• Сгенерируй ответ, например: "Вот твои напоминания."

Если запрос на показ списка повторяющихся напоминаний, то:
• Укажи действие "show_recurring".
• Сгенерируй ответ, например: "Вот твои повторяющиеся напоминания."
	
Выходной JSON должен иметь следующую структуру:
{
  "operations": [
    {
      "action": "create|create_recurring|adjust|delete|show_list|show_recurring",
      "datetime": "2006-01-02 15:04:05",
      "label": "string",
      "reminder_id": "string",
      "answer": "string",
      "start_date": "2006-01-02",
      "end_date": "2006-01-02",
      "recurring_type": "daily|weekly|monthly",
      "time": "15:04",
      "day_of_week": "0-6",
      "day_of_month": "1-31"
    }
  ],
  "user_reminders": [
    {
      "reminder_id": "string",
      "datetime": "2006-01-02 15:04:05",
      "label": "string",
      "description": "string"
    }
  ]
}

При распознавании повторяющихся напоминаний, обрати внимание:
• "Каждый день" или "ежедневно" → recurring_type: "daily"
• "Каждую неделю", "каждый вторник", "еженедельно" → recurring_type: "weekly"
• "Каждый месяц", "каждого 15 числа", "ежемесячно" → recurring_type: "monthly"

При использовании русских дней недели, преобразуй их в числовые значения:
• Воскресенье → 0
• Понедельник → 1
• Вторник → 2
• Среда → 3
• Четверг → 4
• Пятница → 5
• Суббота → 6

Если в ответе встречается дата, выводи её в человеко-понятном формате "02.01.2006" (например, "29.11.2010").
Если какое-либо поле недоступно, оставь его пустым.
Экранируй двойные кавычки (\") и не добавляй лишнего текста.
`

// ReminderBot represents the Telegram bot
type ReminderBot struct {
	config      *config.Config
	bot         *tgbotapi.BotAPI
	repo        *storage.ReminderRepository
	llmClient   *llm.OpenAIClient
	transcriber *speech.Transcriber
	logger      *log.Logger
	stopChan    chan struct{}
}
